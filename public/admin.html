<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Order Status Admin</title>
  <style>
    body {
      font-family: 'Inter', Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    .tab-content {
      background: #fff;
      padding: 32px 32px 24px 32px;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 2px 8px #eee;
      max-width: 1100px;
      margin: 0 auto 32px auto;
      overflow-x: auto;
    }
    #orderLogTable {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 15px;
      min-width: 900px;
      table-layout: fixed;
    }
    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #e5e5e5;
      text-align: left;
      vertical-align: top;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 120px;
    }
    th:nth-child(12), td:nth-child(12) { /* Customer Email */
      max-width: 180px;
    }
    th {
      background: #fafbfc;
      font-weight: 600;
      color: #222;
    }
    tr:nth-child(even) { background: #fcfcfc; }
    tr:hover { background: #f4f8fb; }
    .status-chip {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 13px;
      margin-right: 4px;
      color: #fff;
      font-weight: 500;
    }
    .btn {
      padding: 7px 20px;
      border: none;
      border-radius: 4px;
      background: #007bff;
      color: #fff;
      cursor: pointer;
      font-size: 15px;
      margin-right: 8px;
    }
    .btn:disabled { background: #b3d1ff; cursor: not-allowed; }
    #orderLogTable th, #orderLogTable td { white-space: nowrap; }
    @media (max-width: 1200px) {
      th, td { font-size: 13px; max-width: 90px; }
      #orderLogTable { min-width: 700px; }
    }
    @media (max-width: 900px) {
      .tab-content, .status-form { padding: 8px; }
      table { font-size: 12px; }
      #orderLogTable { min-width: 500px; }
    }
    @media (max-width: 700px) {
      th:nth-child(2), td:nth-child(2), /* Flags */
      th:nth-child(7), td:nth-child(7), /* Fulfillment status */
      th:nth-child(8), td:nth-child(8), /* Tags */
      th:nth-child(10), td:nth-child(10), /* Delivery method */
      th:nth-child(11), td:nth-child(11) /* Channel */
      { display: none; }
    }
    .note-box {
      background:#fff3cd;
      color:#856404;
      padding:10px 20px;
      border-radius:6px;
      margin-bottom:18px;
      border:1px solid #ffeeba;
      max-width:900px;
      margin:auto;
      position:relative;
    }
    .note-box .close-note {
      position:absolute;
      right:12px;
      top:8px;
      font-size:18px;
      color:#856404;
      cursor:pointer;
      background:none;
      border:none;
    }
  </style>
</head>
<body>
  <!-- SMTP Error Note -->
  <div class="note-box" id="smtpNote">
    <button class="close-note" onclick="document.getElementById('smtpNote').style.display='none'">&times;</button>
    <b>Note:</b> If you see <code>553 Relaying disallowed</code> errors, ensure <b>EMAIL_FROM</b> matches your SMTP user email exactly in your environment variables. For Gmail, use your Gmail address and an App Password.
  </div>
  <div class="tabs">
    <button class="tab-btn active" id="tab-status-log">Status Log</button>
    <button class="tab-btn" id="tab-status-mgmt">Order Status Management</button>
  </div>
  <div id="tab-content-status-log" class="tab-content">
    <h2>Status Log</h2>
    <div style="margin-bottom: 16px; display: flex; align-items: center; gap: 24px;">
      <label for="statusFilter">Filter by Status: </label>
      <select id="statusFilter">
        <option value="">All</option>
      </select>
      <input type="text" id="orderSearch" placeholder="Search orders..." style="padding: 6px; width: 240px;" />
    </div>
    <div style="overflow-x:auto; width:100%;">
    <table id="orderLogTable">
      <thead>
        <tr>
          <th>Order</th>
          <th>Flags</th>
          <th>Date</th>
          <th>Customer</th>
          <th>Total</th>
          <th>Payment status</th>
          <th>Fulfillment status</th>
          <th>Tags</th>
          <th>Items</th>
          <th>Delivery method</th>
          <th>Channel</th>
          <th>Customer Email</th>
          <th>Order Statuses</th>
          <th>Add Status</th>
          <th>Save</th>
        </tr>
      </thead>
      <tbody id="orderLogBody"></tbody>
    </table>
    </div>
    <div id="pagination" style="margin-top: 16px; text-align: right;"></div>
  </div>
  <div id="tab-content-status-mgmt" class="tab-content" style="display:none;">
    <h2>Order Status Management</h2>
    <div class="status-form">
      <h4>Add / Edit Status</h4>
      <form id="statusForm">
        <div class="form-row">
          <label for="orderStatus">Order Status</label>
          <input type="text" id="orderStatus" required />
        </div>
        <div class="form-row">
          <label for="color">Color</label>
          <select id="color" required>
            <option value="red">Red</option>
            <option value="green">Green</option>
            <option value="yellow">Yellow</option>
            <option value="blue">Blue</option>
            <option value="light blue">Light Blue</option>
            <option value="light green">Light Green</option>
            <option value="light pink">Light Pink</option>
          </select>
          <span id="colorPreview" class="color-box" style="background: red;"></span>
        </div>
        <div class="form-row">
          <label for="description">Description</label>
          <input type="text" id="description" />
        </div>
        <div class="form-row">
          <label for="topContent">Top Content</label>
          <textarea id="topContent"></textarea>
        </div>
        <div class="form-row">
          <label for="bottomContent">Bottom Content</label>
          <textarea id="bottomContent"></textarea>
        </div>
        <div class="form-row">
          <label class="checkbox-label" for="emailCustomer">Email Customer?</label>
          <input type="checkbox" id="emailCustomer" />
        </div>
        <div class="form-row">
          <label for="emailStaff">Email Staff</label>
          <input type="text" id="emailStaff" placeholder="staff@email.com (optional)" />
        </div>
        <input type="hidden" id="statusId" />
        <button type="submit" class="btn" id="saveBtn">Add Status</button>
        <button type="button" class="btn" id="cancelEdit" style="display:none;">Cancel</button>
      </form>
    </div>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Status</th>
          <th>Color</th>
          <th>Description</th>
          <th>Email Customer?</th>
          <th>Email Staff</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="statusesTable"></tbody>
    </table>
  </div>
  <script>
    const colorMap = {
      'red': '#dc3545',
      'green': '#28a745',
      'yellow': '#ffc107',
      'blue': '#007bff',
      'light blue': '#5bc0de',
      'light green': '#b2f2b2',
      'light pink': '#f8bbd0'
    };
    function fetchStatuses() {
      fetch('/api/statuses').then(r => r.json()).then(data => {
        const tbody = document.getElementById('statusesTable');
        tbody.innerHTML = '';
        data.forEach(s => {
          tbody.innerHTML += `<tr>
            <td>${s.id}</td>
            <td>${s.orderStatus}</td>
            <td><span class="color-box" style="background:${colorMap[s.color]||s.color}"></span> ${s.color}</td>
            <td>${s.description||''}</td>
            <td>${s.emailCustomer ? 'Yes' : 'No'}</td>
            <td>${s.emailStaff||''}</td>
            <td class="actions">
              <button class="btn edit" onclick="editStatus(${s.id})">Edit</button>
              <button class="btn delete" onclick="deleteStatus(${s.id})">Delete</button>
            </td>
          </tr>`;
        });
      });
    }
    function resetForm() {
      document.getElementById('statusForm').reset();
      document.getElementById('statusId').value = '';
      document.getElementById('saveBtn').textContent = 'Add Status';
      document.getElementById('cancelEdit').style.display = 'none';
      document.getElementById('colorPreview').style.background = colorMap['red'];
    }
    document.getElementById('color').addEventListener('change', function() {
      document.getElementById('colorPreview').style.background = colorMap[this.value] || this.value;
    });
    document.getElementById('statusForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const id = document.getElementById('statusId').value;
      const orderStatus = document.getElementById('orderStatus').value.trim();
      const color = document.getElementById('color').value;
      const description = document.getElementById('description').value.trim();
      const topContent = document.getElementById('topContent').value.trim();
      const bottomContent = document.getElementById('bottomContent').value.trim();
      const emailCustomer = document.getElementById('emailCustomer').checked;
      const emailStaff = document.getElementById('emailStaff').value.trim();
      if (!orderStatus) return alert('Order status required');
      const payload = { orderStatus, color, description, topContent, bottomContent, emailCustomer, emailStaff };
      if (id) {
        fetch(`/api/statuses/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        }).then(fetchStatuses);
      } else {
        fetch('/api/statuses', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        }).then(fetchStatuses);
      }
      resetForm();
    });
    window.editStatus = function(id) {
      fetch('/api/statuses').then(r => r.json()).then(data => {
        const s = data.find(x => x.id === id);
        if (!s) return;
        document.getElementById('orderStatus').value = s.orderStatus;
        document.getElementById('color').value = s.color;
        document.getElementById('colorPreview').style.background = colorMap[s.color] || s.color;
        document.getElementById('description').value = s.description||'';
        document.getElementById('topContent').value = s.topContent||'';
        document.getElementById('bottomContent').value = s.bottomContent||'';
        document.getElementById('emailCustomer').checked = !!s.emailCustomer;
        document.getElementById('emailStaff').value = s.emailStaff||'';
        document.getElementById('statusId').value = s.id;
        document.getElementById('saveBtn').textContent = 'Update Status';
        document.getElementById('cancelEdit').style.display = '';
      });
    }
    window.deleteStatus = function(id) {
      if (!confirm('Delete this status?')) return;
      fetch(`/api/statuses/${id}`, { method: 'DELETE' }).then(fetchStatuses);
    }
    document.getElementById('cancelEdit').onclick = resetForm;
    fetchStatuses();

    // --- ORDER STATUS LOG SECTION ---
    // Add after status management
    // HTML for order log
    // const orderLogSection = document.createElement('div');
    // orderLogSection.innerHTML = `
    //   <h2>Status Log</h2>
    //   <table id="orderLogTable">
    //     <thead>
    //       <tr>
    //         <th>Order #</th>
    //         <th>Customer Email</th>
    //         <th>Customer Name</th>
    //         <th>Current Status</th>
    //         <th>Add Status</th>
    //         <th>Save</th>
    //       </tr>
    //     </thead>
    //     <tbody id="orderLogBody"></tbody>
    //   </table>
    // `;
    // document.body.appendChild(orderLogSection);

    let allStatuses = [];
    function fetchAllStatuses() {
      return fetch('/api/statuses').then(r => r.json()).then(data => {
        allStatuses = data;
        return data;
      });
    }
    let allOrders = [];
    let currentPage = 1;
    const pageSize = 20;
    function populateStatusFilter() {
      const filter = document.getElementById('statusFilter');
      filter.innerHTML = '<option value="">All</option>' + allStatuses.map(s => `<option value="${s.orderStatus}">${s.orderStatus}</option>`).join('');
    }
    function renderOrders(orders) {
      const filterVal = document.getElementById('statusFilter').value;
      const searchVal = document.getElementById('orderSearch').value.toLowerCase();
      let filtered = orders.filter(order =>
        (!filterVal || (order.order_statuses||[]).includes(filterVal)) &&
        (
          !searchVal ||
          (order.name && order.name.toLowerCase().includes(searchVal)) ||
          (order.customer && order.customer.toLowerCase().includes(searchVal)) ||
          (order.email && order.email.toLowerCase().includes(searchVal))
        )
      );
      const totalPages = Math.ceil(filtered.length / pageSize);
      if (currentPage > totalPages) currentPage = totalPages || 1;
      const pagedOrders = filtered.slice((currentPage-1)*pageSize, currentPage*pageSize);
      const tbody = document.getElementById('orderLogBody');
      tbody.innerHTML = '';
      pagedOrders.forEach(order => {
        const statusOptions = allStatuses.map(s => `<option value=\"${s.orderStatus}\">${s.orderStatus}</option>`).join('');
        const items = (order.line_items||order.items||[]).map(i => `${i.quantity}x ${i.title||i.name}`).join(', ');
        const tags = Array.isArray(order.tags) ? order.tags.join(', ') : (order.tags || '');
        // Show only the latest status as a chip
        const latestStatus = (order.order_statuses||[]).slice(-1)[0];
        const statusObj = allStatuses.find(s => s.orderStatus === latestStatus);
        const color = statusObj ? colorMap[statusObj.color] : '#888';
        const statusesBox = latestStatus
          ? `<span class=\"status-chip\" style=\"background:${color};\">${latestStatus}</span>`
          : '<em>None</em>';
        tbody.innerHTML += `
          <tr>
            <td>${order.name||order.id}</td>
            <td>${order.flags||''}</td>
            <td>${order.created_at ? new Date(order.created_at).toLocaleString() : ''}</td>
            <td>${order.customer||''}</td>
            <td>${order.total_price||''}</td>
            <td>${order.financial_status||order.payment_status||''}</td>
            <td>${order.fulfillment_status||''}</td>
            <td title="${tags}">${tags.length > 18 ? tags.slice(0, 18) + '…' : tags}</td>
            <td title="${items}">${items.length > 18 ? items.slice(0, 18) + '…' : items}</td>
            <td>${order.delivery_method||((order.shipping_lines||[]).map(s=>s.title).join(', '))||''}</td>
            <td>${order.source_name||order.channel||''}</td>
            <td title="${order.email||''}">${order.email||''}</td>
            <td>${statusesBox}</td>
            <td>
              <select id="status-select-${order.id}">
                <option value="">Select Status</option>
                ${statusOptions}
              </select>
            </td>
            <td><button class="btn" onclick="saveOrderStatus('${order.id}')">Save</button></td>
          </tr>
        `;
      });
      // Pagination controls
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';
      if (totalPages > 1) {
        pagination.innerHTML =
          `<button onclick="prevPage()" ${currentPage===1?'disabled':''}>Prev</button> ` +
          `Page ${currentPage} of ${totalPages} ` +
          `<button onclick="nextPage()" ${currentPage===totalPages?'disabled':''}>Next</button>`;
      }
    }
    function fetchOrdersAndRender() {
      fetchAllStatuses().then(() => {
        populateStatusFilter();
        fetch('/api/orders').then(r => r.json()).then(orders => {
          allOrders = orders;
          renderOrders(allOrders);
        });
      });
    }
    function prevPage() { if (currentPage > 1) { currentPage--; renderOrders(allOrders); } }
    function nextPage() { const totalPages = Math.ceil(allOrders.length / pageSize); if (currentPage < totalPages) { currentPage++; renderOrders(allOrders); } }
    document.getElementById('statusFilter').onchange = function() { currentPage = 1; renderOrders(allOrders); };
    document.getElementById('orderSearch').oninput = function() { currentPage = 1; renderOrders(allOrders); };
    window.saveOrderStatus = function(orderId) {
      const sel = document.getElementById(`status-select-${orderId}`);
      const status = sel.value;
      if (!status) return alert('Please select a status');
      sel.disabled = true;
      fetch(`/api/orders/${orderId}/status`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status })
      }).then(r => r.json()).then(resp => {
        sel.disabled = false;
        if (resp.success) {
          showToast('Status updated and email sent!');
          fetchOrdersAndRender();
        } else {
          alert('Failed to update status: ' + (resp.error||''));
        }
      }).catch(() => {
        sel.disabled = false;
        alert('Failed to update status');
      });
    }
    // Initial fetch
    fetchOrdersAndRender();
    // Optionally, refresh every few minutes
    // setInterval(fetchOrdersAndRender, 5*60*1000);

    // Tab logic
    document.getElementById('tab-status-log').onclick = function() {
      this.classList.add('active');
      document.getElementById('tab-status-mgmt').classList.remove('active');
      document.getElementById('tab-content-status-log').style.display = '';
      document.getElementById('tab-content-status-mgmt').style.display = 'none';
      fetchOrdersAndRender();
    };
    document.getElementById('tab-status-mgmt').onclick = function() {
      this.classList.add('active');
      document.getElementById('tab-status-log').classList.remove('active');
      document.getElementById('tab-content-status-mgmt').style.display = '';
      document.getElementById('tab-content-status-log').style.display = 'none';
    };

    // Toast notification
    function showToast(msg) {
      let toast = document.getElementById('toast');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast';
        toast.style.display = 'none';
        toast.style.position = 'fixed';
        toast.style.top = '32px';
        toast.style.right = '32px';
        toast.style.zIndex = '9999';
        toast.style.minWidth = '220px';
        toast.style.padding = '14px 28px';
        toast.style.background = '#222';
        toast.style.color = '#fff';
        toast.style.borderRadius = '8px';
        toast.style.boxShadow = '0 2px 8px #2228';
        toast.style.opacity = '0.97';
        toast.style.fontSize = '16px';
        toast.style.pointerEvents = 'none';
        document.body.appendChild(toast);
      }
      toast.textContent = msg;
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 2500);
    }
  </script>
</body>
</html> 